package query

import (
	"github.com/bilus/fencer/feature"
)

// ResultKey is a key generated by a mapper, associated with a feature.
type ResultKey any

// ResultEntry is a list of features associated with a result key with
// metadata user code can use for caching etc.
type ResultEntry[K feature.Key, F feature.Feature[K]] struct {
	Features []F
	Meta     interface{}
}

// Result is a map of keys and the corresponding entries containing a query result.
type Result[K feature.Key, F feature.Feature[K]] struct {
	entries map[ResultKey]*ResultEntry[K, F]
}

// UpdateFunc is a callback passed to Result.Update.
type UpdateFunc[K feature.Key, F feature.Feature[K]] func(entry *ResultEntry[K, F]) error

// Update is a method for updating result for a given key.
func (result *Result[K, F]) Update(key ResultKey, f UpdateFunc[K, F]) error {
	m := result.entries
	entry, exists := m[key]
	if !exists {
		entry = &ResultEntry[K, F]{}
		m[key] = entry
	}
	return f(entry)
}

func (result *Result[K, F]) distinct() []F {
	features := make([]F, 0)
	matched := make(map[K]struct{})
	for _, entry := range result.entries {
		for _, feature := range entry.Features {
			key := feature.Key()
			_, isMatched := matched[key]
			if !isMatched {
				features = append(features, feature)
				matched[key] = struct{}{}
			}
		}
	}
	return features
}
